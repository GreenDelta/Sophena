<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>dwdat</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" type="text/css" href="style.css">        
    </head>
    <body>
        <h3 id="header"></h3>
        <canvas id="chart" width="1000" height="400"></canvas>
        <p>Download average data: 
            <a href='#' onclick='saveText()'>avg.txt</a> | 
            <a href='#' onclick='saveJson()'>avg.json</a>
        </p>
        <p id="info"></p>
        <table>
            <thead>
                <tr id="data_header">
                </tr>                             
            </thead>
            <tbody id='data_content'>               
            </tbody>
        </table>
        <script type="text/javascript" src="bower_components/jquery/dist/jquery.min.js"></script>
        <script type="text/javascript" src="bower_components/chartjs/Chart.min.js"></script>
        <script type="text/javascript">
        
        var stationInfo;
        var avgData;

        function saveText() {
            var csv = 'hour\tvalue\n';
            for(var i = 0; i < 8760; i++) {
                csv += (i + 1) + '\t' + avgData[i] + '\n';
            }
            window.open('data:text/csv;charset=utf-8,' + escape(csv));
        }

        function saveJson() {
            var obj = {
                id: stationInfo.id,
                name: stationInfo.name,
                data: avgData
            };
            var s = JSON.stringify(obj);
            window.open('data:application/json;charset=utf-8,' + escape(s));
        }

        $(function() {

            var id = getStationId();
        
            $.get('/station/' + id, function(info) {
                stationInfo = info;
                var text = info.id + ' ' + info.name;
                $('#header').text(text);                  
            });

            $.get('/avgdata/' + id, function(data) {
                avgData = data;
                var labels = [];
                for(var i = 1; i <= 8760; i++) {
                    labels[i-1] = ''; //i.toString();
                }
                var chartData = {
                    labels: labels,
                    datasets: [{
                        label: 'avgdata',
                        strokeColor: '#353535',
                        data: data
                    }]
                };
                var ctx = $("#chart").get(0).getContext("2d");
                new Chart(ctx).Line(chartData, {
                    pointDot: false,
                    animation: false,
                    showTooltips: false,
                    scaleShowGridLines: false,
                    datasetFill: false,
                    bezierCurve: false
                });
            });

            $.get('/data/' + id, function(data) {                
                var years = getYears(data);
                var count = years.length * 8760;
                if(years) {
                    renderHeader(years);
                    window.requestAnimationFrame(function() {
                        renderContent(years, data);
                    });                    
                }
            });

        });

        function getStationId() {
            var search = location.search;
            var id = search.substring(4);
            return id;
        }
        
        function renderHeader(years) {
            var header = $('#data_header');
            header.append('<td>hour</td>');
            $.each(years, function(idx, year) {
                header.append('<td>' + year + '</td>');
            });
        }

        function renderContent(years, data) {
            var content = $('#data_content'); 
            var buffer = '';
            var dataCount = 0;
            var errorCount = 0;           
            for(var i = 0; i < 8760; i++) {
                var hour = i + 1;
                buffer += '<tr><td>' + hour + '</td>';
                for(var k = 0; k < years.length; k++) {
                    var year = years[k];
                    var val = data[year][i];                    
                    if(val === -999) {
                        errorCount++;
                        val = '';
                    } else {
                        dataCount++;
                    }
                    buffer += '<td>' + val + '</td>';
                }
                buffer += '</tr>';
                if(i > 0 && i % 1000 === 0) {
                    content.append(buffer);  
                    buffer = '';
                }           
            }
            content.append(buffer);
            var infoText = dataCount + ' values loaded; ' + 
                            errorCount + ' values missing';
            $('#info').text(infoText);
        }

        function getYears(data) {
            var years = [];
            for(var year in data) {
                years.push(year);
            }
            years.sort();
            return years;
        }

        </script>
    </body>
</html>