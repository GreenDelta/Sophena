<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>dwdat</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" type="text/css" href="style.css">        
    </head>
    <body>
        <h3 id="header"></h3>
        <canvas id="chart" width="1000" height="400"></canvas>
        <p id="info"></p>
        <table>
            <thead>
                <tr id="data_header">
                </tr>                             
            </thead>
            <tbody id='data_content'>               
            </tbody>
        </table>
        <script type="text/javascript" src="bower_components/jquery/dist/jquery.min.js"></script>
        <script type="text/javascript" src="bower_components/chartjs/Chart.min.js"></script>
        <script type="text/javascript">
        
        $(function() {

            var id = getStationId();
            var stationInfo;
            var avgData;
            var data;

            $.get('/station/' + id, function(info) {
                stationInfo = info;
                var text = info.id + ' ' + info.name;
                $('#header').text(text);                  
            });

            $.get('/avgdata/' + id, function(data) {
                var labels = [];
                for(var i = 1; i <= 8760; i++) {
                    labels[i-1] = ''; //i.toString();
                }
                var chartData = {
                    labels: labels,
                    datasets: [{
                        label: 'avgdata',
                        strokeColor: '#353535',
                        data: data
                    }]
                };
                var ctx = $("#chart").get(0).getContext("2d");
                new Chart(ctx).Line(chartData, {
                    pointDot: false,
                    animation: false,
                    showTooltips: false,
                    scaleShowGridLines: false,
                    datasetFill: false,
                    bezierCurve: false
                });
            });

            $.get('/data/' + id, function(data) {
                var years = getYears(data);
                var count = years.length * 8760;
                var infoText = 'Got ' + count + ' data rows from server';
                $('#info').text(infoText);
                if(years) {
                    renderHeader(years);
                    renderContent(years, data);
                }
            });

        });

        function getStationId() {
            var search = location.search;
            var id = search.substring(4);
            return id;
        }
        
        function renderHeader(years) {
            var header = $('#data_header');
            header.append('<td>hour</td>');
            $.each(years, function(idx, year) {
                header.append('<td>' + year + '</td>');
            });
        }

        function renderContent(years, data) {
            var content = $('#data_content'); 
            var buffer = '';           
            for(var i = 0; i < 8760; i++) {
                var hour = i + 1;
                buffer += '<tr><td>' + hour + '</td>';
                for(var k = 0; k < years.length; k++) {
                    var year = years[k];
                    var val = data[year][i];
                    if(val === -999)
                        val = '';
                    buffer += '<td>' + val + '</td>';
                }
                buffer += '</tr>';
                if(i > 0 && i % 1000 === 0) {
                    content.append(buffer);  
                    buffer = '';
                }           
            }
            content.append(buffer);
        }

        function getYears(data) {
            var years = [];
            for(var year in data) {
                years.push(year);
            }
            years.sort();
            return years;
        }

        </script>
    </body>
</html>